<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <title>客户支持（Zendesk Messaging）</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- 本地调试用 CSP（上线请放到响应头并收紧白名单） -->
  <meta http-equiv="Content-Security-Policy"
        content="default-src 'self' https:;
                 script-src 'self' https://cdn.tailwindcss.com https://static.zdassets.com https://*.zdassets.com https://*.zendesk.com 'unsafe-inline' 'unsafe-eval';
                 style-src 'self' https: 'unsafe-inline';
                 img-src 'self' https: data:;
                 font-src 'self' https: data:;
                 connect-src 'self' https://*.zendesk.com https://*.zdassets.com wss://*.zendesk.com https:;
                 frame-src https://*.zendesk.com https://*.zdassets.com;">

  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet"/>
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Zendesk Messaging -->
  <script id="ze-snippet" src="https://static.zdassets.com/ekr/snippet.js?key=f75b1f00-7a81-4047-ae93-e0ca023a9689"></script>

  <style>
    .widget-font{font-family:'Inter',sans-serif}
    .modal-backdrop{background:rgba(0,0,0,.7)}
    .faq-nav-item.active{color:#000}

    #faq-scroll-content::-webkit-scrollbar,#faq-nav::-webkit-scrollbar{width:6px;height:4px}
    #faq-scroll-content::-webkit-scrollbar-track,#faq-nav::-webkit-scrollbar-track{background:#f1f1f1}
    #faq-scroll-content::-webkit-scrollbar-thumb,#faq-nav::-webkit-scrollbar-thumb{background:#bdbdbd;border-radius:20px}
    #faq-scroll-content::-webkit-scrollbar-thumb:hover,#faq-nav::-webkit-scrollbar-thumb:hover{background:#888}

    @keyframes pulse-subtle{0%{box-shadow:0 0 0 0 rgba(20,184,166,.4)}70%{box-shadow:0 0 0 12px rgba(20,184,166,0)}100%{box-shadow:0 0 0 0 rgba(20,184,166,0)}}
    #open-support-btn{animation:pulse-subtle 2.5s infinite}

    .service-btn{display:flex;align-items:center;gap:12px;background:#fff;border:1px solid #e5e7eb;border-radius:12px;padding:16px;min-height:96px;transition:background-color .2s,transform .2s,border-color .2s,box-shadow .2s}
    .service-btn:hover{background:#f9fafb;transform:translateY(-2px);border-color:#d1d5db}
    .service-icon{width:28px;height:28px;min-width:28px;min-height:28px;flex:0 0 28px}
    .service-icon svg{width:100%;height:100%}
    .service-icon svg [stroke]{vector-effect:non-scaling-stroke}

    #faq-search{ background:#fff !important; }
    @media (hover:hover){
      #faq-search{ transition: border-color .18s ease, box-shadow .18s ease; }
      #faq-search:hover{ border-color:#14b8a6; box-shadow:0 0 0 3px rgba(20,184,166,.25); }
    }
    #faq-search:focus,#faq-search:focus-visible{border-color:#14b8a6;box-shadow:0 0 0 3px rgba(20,184,166,.35);outline:none}

    .ann-pill{display:none;width:100%;padding:10px 14px;margin:0 0 12px 0;background:#eff3f6;border-radius:14px;color:#2f7f78;align-items:center;gap:10px;box-sizing:border-box}
    .ann-icon{flex:0 0 22px;height:22px;color:#2f7f78}
    .ann-track{position:relative;height:22px;min-width:0;flex:1;overflow:hidden;line-height:22px}
    .ann-slot{position:absolute;left:0;width:100%;top:0;white-space:nowrap;text-overflow:ellipsis;overflow:hidden;transform:translateY(22px);opacity:0;transition:transform .35s ease,opacity .35s ease;color:inherit;text-decoration:none}
    .ann-slot.active{transform:translateY(0);opacity:1}
    .ann-slot.exit{transform:translateY(-22px);opacity:0}
    .ann-slot:hover{text-decoration:underline}

    /* 隐藏官方 launcher（桌面） */
    iframe[title*="Messaging launcher" i]{display:none!important;opacity:0!important;pointer-events:none!important;visibility:hidden!important}

    /* 自定义“V”关闭（仅桌面） */
    #close-chat-fab{position:fixed;width:32px;height:32px;display:flex;align-items:center;justify-content:center;background:transparent;border:0;color:#2b2f33;cursor:pointer;z-index:2147483650;opacity:0;pointer-events:none;transform:scale(.9);transition:opacity .18s ease,transform .18s ease,top .08s ease,right .08s ease}
    #close-chat-fab.visible{opacity:1;transform:scale(1);pointer-events:auto}
    @media (max-width:520px){#close-chat-fab{display:none!important}}

    /* 语言按钮轻弹 */
    @keyframes press-pop{0%{transform:scale(1)}50%{transform:scale(1.08)}100%{transform:scale(1)}}
    .lang-btn{width:34px;height:34px;display:inline-flex;align-items:center;justify-content:center;border:1px solid #e5e7eb;background:#fff;color:#0f766e;border-radius:9999px;cursor:pointer;transition:background .15s,border-color .15s,transform .15s,box-shadow .15s}
    .lang-btn:hover{background:#f0fdfa;border-color:#14b8a6;transform:translateY(-1px);box-shadow:0 0 0 3px rgba(20,184,166,.18)}
    .lang-btn svg{width:20px;height:20px;display:block}
    .lang-btn.anim-pop{animation:press-pop .22s ease-out}

    /* === 语言弹窗：支持“Widget 内居中”与“贴按钮 Popover”两种模式 === */
    /* 放在 #faq-view 内做绝对定位 */
    .lang-modal-backdrop{
      position:absolute; inset:0;
      display:flex; align-items:center; justify-content:center;
      background:rgba(0,0,0,.45);
      visibility:hidden; opacity:0; pointer-events:none;
      transition:opacity .22s ease; z-index:60;
    }
    .lang-modal{
      width:min(92vw,520px);
      background:#fff; border-radius:18px; box-shadow:0 12px 40px rgba(0,0,0,.18);
      transform:translate(12px,12px) scale(.98); opacity:.96;
      transition:transform .26s cubic-bezier(.16,1,.3,1), opacity .2s ease;
    }
    .lang-modal-backdrop.open{visibility:visible; opacity:1; pointer-events:auto}
    .lang-modal-backdrop.open .lang-modal{transform:translate(0,0) scale(1); opacity:1}
    .lang-modal-backdrop.closing{visibility:visible; opacity:0; pointer-events:none}
    .lang-modal-backdrop.closing .lang-modal{transform:translate(10px,14px) scale(.985); opacity:.92}

    /* 桌面端：作为 Popover 锚定在地球按钮 */
    @media (min-width: 521px){
      .lang-modal-backdrop.as-popover{
        background:transparent;
        visibility:visible; opacity:1; pointer-events:none; /* 只让弹层接收事件 */
      }
      .lang-modal-backdrop.as-popover .lang-modal{
        position:absolute; width:320px; pointer-events:auto;
        top:var(--pop-top,0); left:var(--pop-left,0);
      }
      .lang-modal-backdrop.as-popover .lang-modal::after{
        content:''; position:absolute; width:10px; height:10px; background:#fff;
        box-shadow:0 2px 8px rgba(0,0,0,.12); transform:rotate(45deg);
        left:var(--arrow-left,20px); top:var(--arrow-top,-6px);
      }
      .lang-modal-backdrop.as-popover.pop-above .lang-modal::after{ top:auto; bottom:-6px; }
    }
  </style>
</head>
<body>
  <div id="customer-support-widget-container">
    <!-- 打开按钮（FAQ 入口） -->
    <button id="open-support-btn"
      class="widget-font fixed bottom-8 right-8 bg-teal-600 hover:bg-teal-700 text-white font-semibold p-3 rounded-full shadow-lg flex items-center justify-center transition-all duration-300 z-50"
      aria-label="打开客户支持">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" fill="currentColor" class="w-6 h-6">
        <path d="M425.7 80C391 44.9 342.3 32 296 32h-80c-46.3 0-95 12.9-129.7 48C50.7 115.6 32 163.6 32 208v16c0 8.8-7.2 16-16 16s-16-7.2-16-16V208C0 141.1 23.2 81.1 64.9 41.6S164.9 0 216 0h80c51.1 0 101.1 23.2 141.6 64.9s64.9 96.7 64.9 148.8v16c0 8.8-7.2 16-16 16s-16-7.2-16-16V224c0-44.4-18.7-92.4-54.3-128zM128 224v128c0 26.5-21.5 48-48 48s-48-21.5-48-48V224c0-44.2 35.8-80 80-80h16c44.2 0 80 35.8 80 80v128c0 26.5-21.5 48-48 48s-48-21.5-48-48V224H128zm256 0v128c0 26.5-21.5 48-48 48s-48-21.5-48-48V224c0-44.2 35.8-80 80-80h16c44.2 0 80 35.8 80 80v128c0 26.5-21.5 48-48 48s-48-21.5-48-48V224h-64z"/>
      </svg>
    </button>

    <!-- 自定义“V”（仅桌面） -->
    <button id="close-chat-fab" aria-label="关闭客服聊天">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"
           width="22" height="22" fill="none" stroke="currentColor" stroke-width="3"
           stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
        <polyline points="6 9 12 15 18 9" />
      </svg>
    </button>

    <!-- FAQ 弹层 -->
    <div id="support-modal-backdrop"
         class="widget-font fixed inset-0 z-[1000] modal-backdrop hidden flex items-center justify-center sm:items-end sm:justify-end opacity-0 transition-opacity duration-300 ease-in-out">
      <div id="faq-view"
           class="bg-white text-gray-800 w-full h-full rounded-none sm:rounded-2xl shadow-2xl sm:w-auto sm:max-w-[440px] sm:h-auto sm:max-h-[80vh] sm:mb-24 sm:mr-8 flex flex-col transform transition-all duration-300 ease-in-out scale-95 opacity-0 origin-center sm:origin-bottom-right overflow-hidden relative">

        <!-- 标题 + 语言切换 -->
        <div class="flex-shrink-0 flex justify-between items-center p-6 border-b border-gray-200">
          <h2 id="i18n-title" class="text-2xl font-bold text-black">客户支持</h2>
          <div class="flex items-center gap-3">
            <button id="lang-switch" class="lang-btn" aria-label="切换语言" title="切换语言">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 -960 960 960" fill="currentColor" aria-hidden="true">
                <path d="M480-80q-82 0-155-31.5t-127.5-86Q143-252 111.5-325T80-480q0-83 31.5-155.5t86-127Q252-817 325-848.5T480-880q83 0 155.5 31.5t127 86q54.5 54.5 86 127T880-480q0 82-31.5 155t-86 127.5q-54.5 54.5-127 86T480-80Zm0-82q26-36 45-75t31-83H404q12 44 31 83t45 75Zm-104-16q-18-33-31.5-68.5T322-320H204q29 50 72.5 87t99.5 55Zm208 0q56-18 99.5-55t72.5-87H638q-9 38-22.5 73.5T584-178ZM170-400h136q-3-20-4.5-39.5T300-480q0-21 1.5-40.5T306-560H170q-5 20-7.5 39.5T160-480q0 21 2.5 40.5T170-400Zm216 0h188q3-20 4.5-39.5T580-480q0-21-1.5-40.5T574-560H386q-3 20-4.5 39.5T380-480q0 21 1.5 40.5T386-400Zm268 0h136q5-20 7.5-39.5T800-480q0-21-2.5-40.5T790-560H654q3 20 4.5 39.5T660-480q0 21-1.5 40.5T654-400Zm-16-240h118q-29-50-72.5-87T584-782q18 33 31.5 68.5T638-640Zm-234 0h152q-12-44-31-83t-45-75q-26 36-45 75t-31 83Zm-200 0h118q9-38 22.5-73.5T376-782q-56 18-99.5 55T204-640Z"/>
              </svg>
            </button>
            <button class="close-modal-btn text-gray-400 hover:text-black transition-colors" aria-label="关闭">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 384 512" fill="currentColor" class="w-5 h-5">
                <path d="M342.6 150.6c12.5-12.5 12.5-32.8 0-45.3s-32.8-12.5-45.3 0L192 210.7 86.6 105.4c-12.5-12.5-32.8-12.5-45.3 0s-12.5 32.8 0 45.3L146.7 256 41.4 361.4c-12.5 12.5-12.5 32.8 0 45.3s32.8 12.5 0 45.3L192 301.3 297.4 406.6c12.5 12.5 32.8 12.5 45.3 0s12.5-32.8 0-45.3L237.3 256 342.6 150.6z"/>
              </svg>
            </button>
          </div>
        </div>

        <div id="faq-scroll-content" class="flex-grow min-h-0 p-6 overflow-y-auto">
          <!-- 公告 -->
          <div id="ann-pill" class="ann-pill">
            <svg class="ann-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                 stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
              <rect x="3" y="4" width="18" height="18" rx="3" ry="3"></rect>
              <line x1="3" y1="10" x2="21" y2="10"></line>
            </svg>
            <div id="ann-text" class="ann-track">
              <a class="ann-slot" target="_blank" rel="noopener noreferrer"></a>
              <a class="ann-slot" target="_blank" rel="noopener noreferrer"></a>
            </div>
          </div>

          <p id="i18n-desc" class="text-gray-500 mb-6 text-sm">
            查看下方的常见问题以获得即时解决方案。如果常见问题无法解决您的问题，请点击下面的按钮联系我们的在线支持团队。
          </p>

          <!-- 自助服务 -->
          <div class="mb-8">
            <h3 id="i18n-selfservice" class="text-lg font-semibold text-black mb-4">自助服务</h3>
            <div class="grid grid-cols-2 gap-4">
              <a href="https://100ex.zendesk.com/hc/zh-cn/articles/46056201877529" target="_blank" class="service-btn">
                <span class="service-icon">
                  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 -960 960 960" fill="#00cfb6"><path d="M440-120v-264L254-197l-57-57 187-186H120v-80h264L197-706l57-57 186 187v-264h80v264l186-187 57 57-187 186h264v80H576l187 186-57 57-186-187v264h-80Z"/></svg>
                </span>
                <span id="i18n-tool-1" class="text-gray-900 font-medium">重置谷歌验证器</span>
              </a>
              <a href="https://100ex.zendesk.com/hc/zh-cn/articles/46055234188825" target="_blank" class="service-btn">
                <span class="service-icon">
                  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 -960 960 960" fill="#00cfb6"><path d="M480-360q17 0 28.5-11.5T520-400q0-17-11.5-28.5T480-440q-17 0-28.5 11.5T440-400q0 17 11.5 28.5T480-360Zm-40-160h80v-240h-80v240ZM80-80v-720q0-33 23.5-56.5T160-880h640q33 0 56.5 23.5T880-800v480q0 33-23.5 56.5T800-240H240L80-80Zm126-240h594v-480H160v525l46-45Zm-46 0v-480 480Z"/></svg>
                </span>
                <span id="i18n-tool-2" class="text-gray-900 font-medium">收不到验证码</span>
              </a>
              <a href="https://100ex.zendesk.com/hc/zh-cn/articles/46054832990745" target="_blank" class="service-btn">
                <span class="service-icon">
                  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 -960 960 960" fill="#00cfb6"><path d="M702-480 560-622l57-56 85 85 170-170 56 57-226 226Zm-342 0q-66 0-113-47t-47-113q0-66 47-113t113-47q66 0 113 47t47 113q0 66-47 113t-113 47ZM40-160v-112q0-34 17.5-62.5T104-378q62-31 126-46.5T360-440q66 0 130 15.5T616-378q29 15 46.5 43.5T680-272v112H40Zm80-80h480v-32q0-11-5.5-20T580-306q-54-27-109-40.5T360-360q-56 0-111 13.5T140-306q-9 5-14.5 14t-5.5 20v32Zm240-320q33 0 56.5-23.5T440-640q0-33-23.5-56.5T360-720q-33 0-56.5 23.5T280-640q0 33 23.5 56.5T360-560Zm0 260Zm0-340Z"/></svg>
                </span>
                <span id="i18n-tool-3" class="text-gray-900 font-medium">如何身份认证</span>
              </a>
              <a href="https://100ex.zendesk.com/hc/zh-cn/articles/46055701344921" target="_blank" class="service-btn">
                <span class="service-icon">
                  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 -960 960 960" fill="#00cfb6"><path d="M480-80q-83 0-156-31.5T197-197q-54-54-85.5-127T80-480h80q0 66 25 124.5t68.5 102q43.5 43.5 102 69T480-159q134 0 227-93t93-227q0-134-93-227t-227-93q-89 0-161.5 43.5T204-640h116v80H80v-240h80v80q55-73 138-116.5T480-880q83 0 156 31.5T763-763q54 54 85.5 127T880-480q0 83-31.5 156T763-197q-54 54-127 85.5T480-80Zm-80-240q-17 0-28.5-11.5T360-360v-120q0-17 11.5-28.5T400-520v-40q0-33 23.5-56.5T480-640q33 0 56.5 23.5T560-560v40q17 0 28.5 11.5T600-480v120q0 17-11.5 28.5T560-320H400Zm40-200h80v-40q0-17-11.5-28.5T480-600q-17 0-28.5 11.5T440-560v40Z"/></svg>
                </span>
                <span id="i18n-tool-4" class="text-gray-900 font-medium">忘记密码怎么办</span>
              </a>
            </div>
          </div>

          <!-- 动态 FAQ -->
          <div>
            <h3 id="i18n-faq" class="text-lg font-semibold text-black mb-4">常见问题</h3>
            <div class="relative mb-4">
              <span class="absolute inset-y-0 left-0 flex items-center pl-3">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" fill="currentColor" class="w-4 h-4 text-gray-400"><path d="M416 208c0 45.9-14.9 88.3-40 122.7L502.6 457.4c12.5 12.5 12.5 32.8 0 45.3s-32.8 12.5-45.3 0L330.7 376c-34.4 25.2-76.8 40-122.7 40C93.1 416 0 322.9 0 208S93.1 0 208 0S416 93.1 416 208zM208 352a144 144 0 1 0 0-288 144 144 0 1 0 0 288z"/></svg>
              </span>
              <input type="search" id="faq-search" class="w-full bg-white border border-gray-300 text-gray-900 rounded-lg p-2 pl-10" placeholder="搜索问题...">
            </div>

            <div class="flex min-h-0">
              <nav id="faq-nav" class="relative flex flex-col border-r-2 border-gray-200 pr-4 min-w-[180px]">
                <div id="faq-nav-highlighter" class="absolute right-[-2px] w-0.5 bg-teal-600 transition-all duration-300 ease-in-out" style="opacity:0"></div>
              </nav>
              <div id="faq-results-container" class="flex-grow min-h-0 pl-6">
                <ul id="faq-list" class="space-y-5"></ul>
                <p id="no-results" class="text-gray-500 hidden">没有找到相关结果。</p>
                <p id="faq-loading" class="text-gray-500">加载中...</p>
                <button id="faq-retry" class="hidden mt-3 inline-flex items-center px-3 py-1.5 text-sm border rounded hover:bg-gray-50">重试</button>
              </div>
            </div>
          </div>

          <div class="flex-shrink-0 mt-6">
            <button id="start-chat-from-faq-btn" class="w-full bg-teal-600 hover:bg-teal-700 text-white font-semibold py-3 px-6 rounded-lg flex items-center justify-center gap-3 transition-colors duration-200">
              <span id="i18n-chat">客户支持</span>
            </button>
          </div>
        </div>

        <!-- 语言选择弹窗：移动端居中；桌面贴“地球”按钮 Popover -->
        <div id="lang-backdrop" class="lang-modal-backdrop">
          <div class="lang-modal">
            <div class="flex items-center justify-between p-5 border-b border-gray-200">
              <h3 id="i18n-lang-title" class="text-xl font-semibold">选择语言</h3>
              <button id="lang-close" class="text-gray-400 hover:text-black" aria-label="关闭">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 384 512" fill="currentColor" width="18" height="18">
                  <path d="M342.6 150.6c12.5-12.5 12.5-32.8 0-45.3s-32.8-12.5-45.3 0L192 210.7 86.6 105.4c-12.5-12.5-32.8-12.5-45.3 0s-12.5 32.8 0 45.3L146.7 256 41.4 361.4c-12.5 12.5-12.5 32.8 0 45.3s32.8 12.5 0 45.3L192 301.3 297.4 406.6c12.5 12.5 32.8 12.5 45.3 0s12.5-32.8 0-45.3L237.3 256 342.6 150.6z"/>
                </svg>
              </button>
            </div>
            <div class="p-5 grid grid-cols-2 gap-4">
              <button id="lang-zh" type="button" class="lang-opt border rounded-[14px] h-16 font-semibold">简体中文</button>
              <button id="lang-en" type="button" class="lang-opt border rounded-[14px] h-16 font-semibold">English</button>
            </div>
          </div>
        </div>
        <!-- /语言选择弹窗 -->

      </div>
    </div>
  </div>

  <script>
  (function(){
    const ZD = { base:'https://100ex.zendesk.com' };
    const FETCH_TIMEOUT_MS = 6000;

    const LANGS = {
      zh:{ locale:'zh-cn', faqCatId:'45495601653401', announceCatId:'45495487972633', ui:{
        title:'客户支持', desc:'查看下方的常见问题以获得即时解决方案。如果常见问题无法解决您的问题，请点击下面的按钮联系我们的在线支持团队。',
        selfservice:'自助服务', faq:'常见问题', chat:'客户支持', searchPH:'搜索问题...', noResult:'没有找到相关结果。',
        loading:'加载中...', tool1:'重置谷歌验证器', tool2:'收不到验证码', tool3:'如何身份认证', tool4:'忘记密码怎么办',
        langTitle:'选择语言', zhBtn:'简体中文', enBtn:'English'
      }},
      en:{ locale:'en-us', faqCatId:'45222043871257', announceCatId:'45222030451097', ui:{
        title:'Support', desc:'Browse FAQs below for instant answers. If that doesn’t help, contact our live support via the button.',
        selfservice:'Self Service', faq:'FAQs', chat:'Live Support', searchPH:'Search…', noResult:'No results found.',
        loading:'Loading…', tool1:'Reset Google Authenticator', tool2:'Didn’t receive verification code',
        tool3:'How to Verify Identity', tool4:'Forgot Password', langTitle:'Choose Language',
        zhBtn:'Chinese (Simplified)', enBtn:'English'
      }}
    };

    let cur='zh';
    const ui=(k)=>LANGS[cur].ui[k];

    const openBtn=document.getElementById('open-support-btn');
    const modal=document.getElementById('support-modal-backdrop');
    const faqView=document.getElementById('faq-view');
    const startChat=document.getElementById('start-chat-from-faq-btn');
    const closeFab=document.getElementById('close-chat-fab');

    const faqNav=document.getElementById('faq-nav');
    const faqList=document.getElementById('faq-list');
    const faqSearch=document.getElementById('faq-search');
    const faqLoading=document.getElementById('faq-loading');
    const faqRetry=document.getElementById('faq-retry');
    const noResults=document.getElementById('no-results');

    const titleEl=document.getElementById('i18n-title');
    const descEl=document.getElementById('i18n-desc');
    const selfEl=document.getElementById('i18n-selfservice');
    const faqEl=document.getElementById('i18n-faq');
    const chatEl=document.getElementById('i18n-chat');
    const t1El=document.getElementById('i18n-tool-1');
    const t2El=document.getElementById('i18n-tool-2');
    const t3El=document.getElementById('i18n-tool-3');
    const t4El=document.getElementById('i18n-tool-4');

    const annPill=document.getElementById('ann-pill');
    const annTrack=document.getElementById('ann-text');
    const annSlots=annTrack.querySelectorAll('.ann-slot');

    const langBtn=document.getElementById('lang-switch');
    const langBackdrop=document.getElementById('lang-backdrop');
    const langCloseBtn=document.getElementById('lang-close');
    const btnZh=document.getElementById('lang-zh');
    const btnEn=document.getElementById('lang-en');

    /* 小工具 */
    const debounce=(fn,ms=200)=>{let t;return(...a)=>{clearTimeout(t);t=setTimeout(()=>fn(...a),ms)}}
    function onZEReady(cb){ if(typeof zE==='function'){ zE(cb); } else setTimeout(()=>onZEReady(cb),60); }
    function isMobile(){ return Math.min(window.innerWidth, document.documentElement.clientWidth||window.innerWidth) <= 520; }
    function escapeHtml(s){ return String(s||'').replace(/[&<>"]/g, ch => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[ch])); }
    async function fetchWithTimeout(url){
      const c=new AbortController(); const to=setTimeout(()=>c.abort(),FETCH_TIMEOUT_MS);
      try{ const res=await fetch(url,{signal:c.signal}); clearTimeout(to); if(!res.ok) throw new Error(res.status); return await res.json(); }
      catch(e){ clearTimeout(to); throw e; }
    }
    function secListUrl(catId,loc){return `${ZD.base}/api/v2/help_center/${(loc||'zh-cn').toLowerCase()}/categories/${catId}/sections.json?per_page=100&sort_by=position`}
    function secArticlesUrl(secId,per,loc){return `${ZD.base}/api/v2/help_center/${(loc||'zh-cn').toLowerCase()}/sections/${secId}/articles.json?per_page=${per||30}&sort_by=updated_at&sort_order=desc`}
    function catArticlesUrl(catId,per,loc){return `${ZD.base}/api/v2/help_center/categories/${catId}/articles.json?per_page=${per||10}&sort_by=updated_at&sort_order=desc&locale=${encodeURIComponent((loc||'zh-cn').toLowerCase())}`}

    // 初始：桌面隐藏 launcher
    onZEReady(()=>{
      try{
        if(!isMobile()){
          zE('messenger','hide');
          hideLauncher(); // 确保 Zendesk SDK 加载后立即隐藏
        }
      }catch(e){};
    });

    /* 公告轮播 */
    let annItems=[], annIdx=0, annTimer=null, currentSlotIndex=0;
    function setSlot(el,item){ el.textContent=escapeHtml(item?.title||''); el.href=item?.url||'#'; }
    function stopAnnRotation(){ if(annTimer){ clearInterval(annTimer); annTimer=null; } }
    function slideTo(nextIndex){
      if(!annSlots.length||!annItems.length) return;
      const curSlot=annSlots[currentSlotIndex], nxt=annSlots[1-currentSlotIndex];
      setSlot(nxt,annItems[nextIndex]); nxt.className='ann-slot'; void nxt.offsetHeight;
      nxt.classList.add('active'); curSlot.classList.remove('active'); curSlot.classList.add('exit');
      curSlot.addEventListener('transitionend',()=>{curSlot.className='ann-slot';},{once:true});
      currentSlotIndex=1-currentSlotIndex; annIdx=nextIndex;
    }
    async function loadAnnouncements(){
      stopAnnRotation();
      const lang=LANGS[cur]; const catId=(lang.announceCatId||'').trim();
      if(!catId){ annPill.style.display='none'; console.warn("Announcement category ID is not set."); return; } // Add console warning for debugging
      try{
        const data=await fetchWithTimeout(catArticlesUrl(catId,10,lang.locale));
        annItems=(data.articles||[]).map(a=>({title:(a.title||'').trim(),url:a.html_url})).filter(x=>x.title);
      }catch(e){
        annItems=[];
        console.error("Failed to fetch announcements:", e); // Log the error for debugging
      }

      if(!annSlots.length||!annItems.length){ annPill.style.display='none'; return; }
      
      // Only show the pill if there are announcements to display
      annPill.style.display='flex';
      
      annIdx=0; currentSlotIndex=0;
      setSlot(annSlots[0],annItems[0]); annSlots[0].className='ann-slot active'; annSlots[1].className='ann-slot';
      if(annItems.length>1){ annTimer=setInterval(()=>slideTo((annIdx+1)%annItems.length),4200); }
    }

    /* FAQ 数据 */
    const faqState={sections:[],articlesBySection:{},allArticles:[]};
    function renderNav(sections){
      faqNav.innerHTML='<div id="faq-nav-highlighter" class="absolute right-[-2px] w-0.5 bg-teal-600 transition-all duration-300 ease-in-out" style="opacity:0"></div>';
      sections.forEach((s,i)=>{
        const a=document.createElement('a'); a.href='#'; a.dataset.sectionId=s.id;
        a.className='faq-nav-item text-gray-500 hover:text-black block whitespace-nowrap pr-8 pl-4 py-2';
        a.textContent=s.name||('Section '+s.id);
        if(i===0){ a.classList.add('active','font-semibold'); a.classList.remove('text-gray-500'); }
        faqNav.appendChild(a);
      });
      setTimeout(()=>{ const first=faqNav.querySelector('.faq-nav-item'); if(first){ const hl=document.getElementById('faq-nav-highlighter'); hl.style.opacity='1'; hl.style.top=`${first.offsetTop}px`; hl.style.height=`${first.offsetHeight}px`; }},80);
    }
    function renderArticles(list){
      faqLoading.classList.add('hidden'); faqRetry.classList.add('hidden');
      if(!list||!list.length){ faqList.innerHTML=''; noResults.textContent=ui('noResult'); noResults.classList.remove('hidden'); return; }
      noResults.classList.add('hidden');
      faqList.innerHTML=list.map(a=>`<li><a href="${a.html_url}" target="_blank" rel="noopener noreferrer" class="hover:text-teal-600 transition-colors">${(a.title||'').replace(/[&<>"]/g,s=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[s]))}</a></li>`).join('');
    }
    async function loadFAQ(){
      const lang=LANGS[cur]; const catId=(lang.faqCatId||'').trim();
      if(!catId){ faqLoading.textContent=lang.ui.loading+'（未配置分类ID）'; return; }
      faqLoading.textContent=lang.ui.loading; faqLoading.classList.remove('hidden'); noResults.classList.add('hidden');
      faqList.innerHTML=''; faqNav.innerHTML=''; faqState.sections=[]; faqState.articlesBySection={}; faqState.allArticles=[];
      try{
        const secResp=await fetchWithTimeout(secListUrl(catId,lang.locale));
        const sections=(secResp.sections||[]).sort((a,b)=>(a.position||0)-(b.position||0));
        faqState.sections=sections; renderNav(sections);
        const perSec=30;
        const all=await Promise.all(sections.map(async s=>{
          try{ const artResp=await fetchWithTimeout(secArticlesUrl(s.id,perSec,lang.locale));
               const arts=artResp.articles||[]; faqState.articlesBySection[s.id]=arts; return arts;
          }catch{ faqState.articlesBySection[s.id]=[]; return []; }
        }));
        faqState.allArticles=all.flat();
        renderArticles(faqState.articlesBySection[sections[0]?.id]||[]);
      }catch(e){
        console.error("Failed to fetch FAQ:", e); // Log the error for debugging
        faqLoading.classList.add('hidden'); faqRetry.classList.remove('hidden'); faqRetry.onclick=()=>loadFAQ();
      }
    }

    function applyI18n(){
      const lang=LANGS[cur];
      titleEl.textContent=lang.ui.title; descEl.textContent=lang.ui.desc; selfEl.textContent=lang.ui.selfservice;
      faqEl.textContent=lang.ui.faq; chatEl.textContent=lang.ui.chat;
      faqSearch.placeholder=lang.ui.searchPH; noResults.textContent=lang.ui.noResult; faqLoading.textContent=lang.ui.loading;
      t1El.textContent=lang.ui.tool1; t2El.textContent=lang.ui.tool2; t3El.textContent=lang.ui.tool3; t4El.textContent=lang.ui.tool4;
      document.getElementById('i18n-lang-title').textContent=lang.ui.langTitle;
      btnZh.textContent=lang.ui.zhBtn; btnEn.textContent=lang.ui.enBtn;
      const toEn=(cur==='zh'); langBtn.setAttribute('title',toEn?'Switch to English':'切换到中文'); langBtn.setAttribute('aria-label',toEn?'Switch to English':'切换到中文');
    }

    /* 打开/关闭 FAQ */
    openBtn.addEventListener('click', async ()=>{
      onZEReady(()=>{ try{ if(!isMobile()){ zE('messenger','hide'); hideLauncher(); } }catch(e){}; closeFab.classList.remove('visible'); });
      modal.classList.remove('hidden');
      setTimeout(()=>{ modal.classList.remove('opacity-0'); faqView.classList.remove('opacity-0','scale-95'); },10);
      applyI18n(); 
      // Await both promises to ensure content is loaded before displaying
      await Promise.all([loadAnnouncements(),loadFAQ()]).catch(e => {
        // Log errors from the async calls, but don't block the UI
        console.error("Error during initial content load:", e);
      });
    });
    function closeModal(){ modal.classList.add('opacity-0'); faqView.classList.add('opacity-0','scale-95'); setTimeout(()=>modal.classList.add('hidden'),300); }
    document.querySelectorAll('.close-modal-btn').forEach(b=>b.addEventListener('click', closeModal));
    modal.addEventListener('click', e=>{ if(e.target===modal) closeModal(); });

    /* 语言弹窗：打开 = 桌面锚定；移动端居中 */
    function openLangModal(){
      btnZh.classList.toggle('active',cur==='zh');
      btnEn.classList.toggle('active',cur==='en');

      langBtn.classList.add('anim-pop'); setTimeout(()=>langBtn.classList.remove('anim-pop'),240);

      langBackdrop.classList.remove('closing','as-popover','pop-above');

      if (!isMobile()) {
        // 桌面：计算地球按钮相对 #faq-view 的位置
        const viewRect = faqView.getBoundingClientRect();
        const btnRect  = langBtn.getBoundingClientRect();

        const popW = 320, popH = 160; // 估算高度
        let left = btnRect.left - viewRect.left - 6;   // 稍微左一点
        let top  = btnRect.bottom - viewRect.top + 10; // 按钮下方 10px
        let above = false;

        const maxLeft = viewRect.width - popW - 12;
        if (left > maxLeft) left = Math.max(12, maxLeft);

        if (top + popH > viewRect.height) { // 下方放不下，翻到上方
          top  = btnRect.top - viewRect.top - popH - 10;
          above = true;
        }

        const btnCenter = btnRect.left - viewRect.left + btnRect.width/2;
        let arrowLeft = btnCenter - left - 5;
        arrowLeft = Math.max(18, Math.min(popW - 28, arrowLeft));

        langBackdrop.style.setProperty('--pop-top',  top + 'px');
        langBackdrop.style.setProperty('--pop-left', left + 'px');
        langBackdrop.style.setProperty('--arrow-left', arrowLeft + 'px');
        langBackdrop.style.setProperty('--arrow-top', above ? 'auto' : '-6px');
        if (above) langBackdrop.classList.add('pop-above');

        langBackdrop.classList.add('as-popover');
      } else {
        // 移动端：居中遮罩
        document.documentElement.style.overflow = 'hidden';
      }

      void langBackdrop.offsetWidth; // 触发过渡
      langBackdrop.classList.add('open');
    }
    function closeLangModal(){
      langBackdrop.classList.remove('open');
      langBackdrop.classList.add('closing');
      const done = () => {
        langBackdrop.classList.remove('closing','as-popover','pop-above');
        langBackdrop.style.removeProperty('--pop-top');
        langBackdrop.style.removeProperty('--pop-left');
        langBackdrop.style.removeProperty('--arrow-left');
        langBackdrop.style.removeProperty('--arrow-top');
        document.documentElement.style.overflow = '';
        langBackdrop.removeEventListener('transitionend', done);
      };
      langBackdrop.addEventListener('transitionend', done);
    }
    langBtn.addEventListener('click', openLangModal);
    langCloseBtn.addEventListener('click', closeLangModal);
    langBackdrop.addEventListener('click', (e)=>{ if(e.target===langBackdrop) closeLangModal(); });
    btnZh.addEventListener('click', ()=>{
      if (cur!=='zh'){ cur='zh'; applyI18n(); }
      closeLangModal(); Promise.all([loadAnnouncements(),loadFAQ()]).catch(()=>{});
    });
    btnEn.addEventListener('click', ()=>{
      if (cur!=='en'){ cur='en'; applyI18n(); }
      closeLangModal(); Promise.all([loadAnnouncements(),loadFAQ()]).catch(()=>{});
    });

    /* 从 FAQ 打开聊天 */
    startChat.addEventListener('click', ()=>{
      closeModal();
      onZEReady(()=>{ try{ zE('messenger','show'); zE('messenger','open'); }catch(e){}; alignDesktopClose(); });
    });

    /* 自定义“V” */
    closeFab.addEventListener('click', () => {
      onZEReady(() => {
        try { zE('messenger','close'); } catch(e){}
        try { zE('messenger','hide'); } catch(e){}
        closeFab.classList.remove('visible');
      });
    });

    function getChatFrame(){
      const frames=[...document.querySelectorAll('iframe')].map(f=>({f,r:f.getBoundingClientRect(),t:(f.title||'').toLowerCase(),s:(f.src||'').toLowerCase()}))
        .filter(x=> (x.s.includes('zdassets.com')||x.t.includes('zendesk')||x.t.includes('messaging')));
      if(!frames.length) return null;
      frames.sort((a,b)=>(b.r.width*b.r.height)-(a.r.width*a.r.height));
      return frames[0].f;
    }
    function isChatExpanded(){
      const f = getChatFrame();
      if (!f) return false;
      const r = f.getBoundingClientRect();
      const style = window.getComputedStyle(f);
      const visible = style && style.display !== 'none' && style.visibility !== 'hidden' && parseFloat(style.opacity||'1') > 0.01;
      const expanded = r.height >= 180 && r.width >= 260 && visible &&
                       r.bottom > 0 && r.right > 0 && r.top < window.innerHeight && r.left < window.innerWidth;
      return expanded;
    }
    function placeV(frame){
      if(!frame || !isChatExpanded()) { closeFab.classList.remove('visible'); return; }
      const r=frame.getBoundingClientRect();
      const headerH=56, btnH=28, vOffset=Math.max(8,(headerH-btnH)/2);
      closeFab.classList.add('visible');
      closeFab.style.left='auto';
      closeFab.style.right=(window.innerWidth - r.right + 12)+'px';
      closeFab.style.top=(r.top + vOffset)+'px';
    }

    let rafId=null;
    function alignDesktopClose(){
      if (isMobile()) return;
      cancelAnimationFrame(rafId);
      const loop=()=>{ const f=getChatFrame(); if(f) placeV(f); rafId=requestAnimationFrame(loop); };
      rafId=requestAnimationFrame(loop);
    }
    function stopAlign(){ cancelAnimationFrame(rafId); rafId=null; closeFab.classList.remove('visible'); }

    onZEReady(()=>{ try{
      zE('messenger:on','open',  ()=>{ alignDesktopClose(); });
      zE('messenger:on','close', ()=>{ try{ zE('messenger','hide'); }catch(e){}; stopAlign(); });
      zE('messenger:on','hide',  ()=>{ stopAlign(); });
    }catch(_){}});

    function hideLauncher(){
      if (isMobile()) return;
      document.querySelectorAll('iframe').forEach(f=>{
        const t=(f.title||'').toLowerCase(), s=(f.src||'').toLowerCase();
        const r=f.getBoundingClientRect();
        const zend = s.includes('zdassets.com')||s.includes('zendesk.com')||t.includes('zendesk')||t.includes('messaging');
        const looksLikeLauncher = (r.width<=120 && r.height<=120);
        if(zend && looksLikeLauncher){
          f.style.setProperty('display','none','important');
          f.style.setProperty('visibility','hidden','important');
          f.style.setProperty('opacity','0','important');
          f.style.setProperty('pointer-events','none','important');
          f.style.setProperty('width','0','important');
          f.style.setProperty('height','0','important');
        }
      });
    }
    setInterval(hideLauncher,900);
    new MutationObserver(hideLauncher).observe(document.documentElement,{childList:true,subtree:true});

    /* FAQ 导航/搜索 */
    faqNav.addEventListener('click', e=>{
      const a=e.target.closest('.faq-nav-item'); if(!a) return; e.preventDefault();
      faqSearch.value=''; document.querySelectorAll('.faq-nav-item').forEach(i=>{i.classList.remove('active','font-semibold'); i.classList.add('text-gray-500');});
      a.classList.add('active','font-semibold'); a.classList.remove('text-gray-500');
      const hl=document.getElementById('faq-nav-highlighter'); hl.style.opacity='1'; hl.style.top=`${a.offsetTop}px`; hl.style.height=`${a.offsetHeight}px`;
      renderArticles((faqState.articlesBySection||{})[a.dataset.sectionId]||[]);
    });

    const doSearch=(function(){
      const fn=()=>{
        const q=(faqSearch.value||'').trim().toLowerCase();
        const hl=document.getElementById('faq-nav-highlighter');
        if(!q){
          const act=faqNav.querySelector('.faq-nav-item.active');
          if(act){ renderArticles((faqState.articlesBySection||{})[act.dataset.sectionId]||[]); if(hl){hl.style.opacity='1'; hl.style.top=`${act.offsetTop}px`; hl.style.height=`${act.offsetHeight}px`;} }
          return;
        }
        if(hl) hl.style.opacity='0'; document.querySelectorAll('.faq-nav-item').forEach(i=>i.classList.remove('active','font-semibold'));
        renderArticles((faqState.allArticles||[]).filter(a=>(a.title||'').toLowerCase().includes(q)));
      };
      return (ms=>{ let t; return ()=>{ clearTimeout(t); t=setTimeout(fn,ms||180); }; })(180);
    })();
    faqSearch.addEventListener('input',doSearch);
  })();
  </script>
</body>
</html>
